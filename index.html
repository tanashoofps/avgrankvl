<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VALORANT フルパ平均ランク計算</title>
  <style>
    :root { --bg:#0f1115; --panel:#161a22; --text:#e7eaf0; --muted:#a9b0bf; --accent:#5865f2; --danger:#ff5470; }
    * { box-sizing: border-box }
    body { margin:0; background:var(--bg); color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP","Hiragino Sans","Yu Gothic UI", sans-serif; }
    header { padding:22px 16px; text-align:center; border-bottom:1px solid #232837; background:linear-gradient(180deg,#131826,transparent); }
    header h1 { margin:0 0 6px; font-size:22px }
    header p  { margin:0; color:var(--muted); font-size:13px }

    main {
      max-width: 1200px; margin: 24px auto; padding: 0 16px;
      display:grid; gap:16px;
    }
    @media (min-width: 1100px){
      main{
        grid-template-columns: 2fr 1fr;
        grid-template-areas:
          "how   how"
          "input save";
      }
    }
    @media (max-width: 1099px){
      main{ grid-template-columns: 1fr; grid-template-areas: "how" "input" "save"; }
    }

    section { background:var(--panel); border:1px solid #202534; border-radius:12px; padding:16px }
    #sec-how-wrap   { grid-area: how }
    #sec-input-wrap { grid-area: input }
    #sec-save-wrap  { grid-area: save }

    section h2 { margin:0 0 12px; font-size:16px }
    label { display:block; font-size:12px; color:var(--muted); margin-bottom:6px }

    select, input[type=text]{
      width:100%; background:#0f1320; color:var(--text);
      border:1px solid #242a3b; border-radius:10px;
      padding:10px 22px 10px 12px; font-size:15px; line-height:1.3; outline:none;
    }
    select:focus, input[type=text]:focus { border-color: var(--accent) }
    .row{ display:grid; grid-template-columns: repeat(5, minmax(160px, 1fr)); gap:10px }

    .controls{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:12px }
    button{
      background:var(--accent); color:#fff; border:none; padding:10px 14px; border-radius:10px;
      font-weight:700; cursor:pointer; font-size:14px;
    }
    button.secondary { background:#2d344b }
    button.danger    { background:#ff5470 }
    button:disabled  { opacity:.5; cursor:not-allowed }

    small.helper{ color:var(--muted) }
    .result{ border:1px dashed #2b3246; padding:12px; border-radius:10px; background:#111522; margin-top:8px }

    ul.list{ list-style:none; padding:0; margin:0; display:grid; gap:10px }
    .team{ display:flex; gap:10px; align-items:center; justify-content:space-between; padding:12px; background:#0f1320; border:1px solid #232a41; border-radius:10px }
    .team .meta{ font-size:13px; color:var(--muted) }
  </style>
</head>
<body>
  <header>
    <h1>VALORANT フルパ平均ランク計算</h1>
  </header>

  <main>
    <section id="sec-how-wrap" aria-labelledby="sec-how">
      <h2 id="sec-how">使用方法</h2>
      <ol>
        <li>下の平均ランクで、5つの枠から各メンバーのランクを選んでください。</li>
        <li>5つの枠すべて選ぶと自動で平均ランクが表示されます。計算方式はnearest（四捨五入）/ floor（切り捨て）で切替可能。</li>
        </li>（Unrated/Unrankedは計算から除外されます。）</li>
        <li>右側の保存でチーム名を付けて保存／読み込み／削除ができます。同名は上書き確認のうえ更新されます。</li>
      </ol>
    </section>
    <section id="sec-input-wrap" aria-labelledby="sec-input">
      <h2 id="sec-input">平均ランク</h2>
      <div class="row" id="select-row" aria-live="polite"></div>

      <div class="controls">
        <div>
          <label for="rounding">計算方式</label>
          <select id="rounding" aria-label="計算方式">
            <option value="nearest" selected>nearest（四捨五入）</option>
            <option value="floor">floor（切り捨て）</option>
          </select>
        </div>
        <div>
          <label>Unrated/Unranked</label>
          <span>除外（固定）</span>
        </div>
        <button id="clear-all" class="secondary" type="button">全クリア</button>
      </div>

      <p id="progress"><small class="helper">未選択: 5 / 5</small></p>
      <div class="result" id="result" role="status" aria-live="polite">
        平均ランク : —（5人すべて選択してください）
      </div>
    </section>
    <section id="sec-save-wrap" aria-labelledby="sec-save">
      <h2 id="sec-save">保存</h2>
      <label for="team-name">チーム名</label>
      <input id="team-name" type="text" placeholder="例: 週末フルパA" />
      <div class="controls">
        <button id="save-team" type="button">保存</button>
        <button id="delete-all" class="danger" type="button">すべて削除</button>
      </div>
      <p><small class="helper">保存先 : この端末のブラウザ</small></p>
      <h3 style="margin:12px 0 6px;font-size:14px">保存済みチーム</h3>
      <ul id="team-list" class="list" aria-live="polite" aria-label="保存済みチーム一覧"></ul>
    </section>

  </main>

  <script>
    const TIERS = ['Iron','Bronze','Silver','Gold','Platinum','Diamond','Ascendant','Immortal'];
    const RANK_LABELS = []; for (const t of TIERS) for (let d=1; d<=3; d++) RANK_LABELS.push(`${t} ${d}`); RANK_LABELS.push('Radiant');

    const COLOR = {
      Iron:'#9aa5ad',
      Bronze:'#cd7f32',
      Silver:'#e7eaf0',
      Gold:'#f1c40f',
      Platinum:'#19c3ff',
      Diamond:'#b388ff',
      Ascendant:'#2ecc71',
      Immortal:'#d81b60',
      Radiant:'#fff176'
    };

    function normalizeRank(input){
      if(!input) return '';
      let s = String(input).trim().toLowerCase();
      s = s.replace(/[^\w\s]/g,' ').replace(/\s+/g,' ').trim();
      s = s.replace(/\biii\b/g,'3').replace(/\bii\b/g,'2').replace(/\bi\b/g,'1');
      s = s.replace(/\bplat\b/g,'platinum').replace(/\bpltnm\b/g,'platinum');
      s = s.replace(/\bdia\b/g,'diamond'); s = s.replace(/\basc\b/g,'ascendant'); s = s.replace(/\bimm\b/g,'immortal');
      s = s.replace(/\bbron\b/g,'bronze').replace(/\bsil\b/g,'silver');
      if (s === 'radiant' || /\bradiant\b/.test(s)) return 'radiant';
      s = s.replace(/\b(iron|bronze|silver|gold|platinum|diamond|ascendant|immortal)\s*([123])\b/, '$1 $2');
      return s;
    }
    function rankToOrdinal(rankStr){
      if(!rankStr) return null;
      if(/^(unrated|unranked)$/i.test(rankStr)) return null;
      const s = normalizeRank(rankStr);
      if (s === 'radiant') return 25;
      const m = s.match(/\b(iron|bronze|silver|gold|platinum|diamond|ascendant|immortal)\b(?:\s+([123]))?/);
      if(!m) return null;
      const tierName = m[1][0].toUpperCase()+m[1].slice(1);
      const tierIndex = TIERS.indexOf(tierName);
      const div = m[2] ? Number(m[2]) : (m[1] === 'immortal' ? 3 : 1);
      if(tierIndex < 0 || div < 1 || div > 3) return null;
      return tierIndex*3 + div; // 1..24
    }
    function ordinalToRank(n){ const idx = Math.max(1, Math.min(25, Math.round(n))); return idx === 25 ? 'Radiant' : RANK_LABELS[idx-1]; }
    function getAvgFromOrdinals(ordinals, rounding='nearest'){
      const arr = ordinals.filter(n => typeof n === 'number');
      if(arr.length === 0) return { used:0, avgLabel:'N/A' };
      const avg = arr.reduce((a,b)=>a+b,0)/arr.length;
      const fin = rounding === 'floor' ? Math.floor(avg) : Math.round(avg);
      const clamped = Math.max(1, Math.min(25, fin));
      return { used: arr.length, avgLabel: ordinalToRank(clamped) };
    }

    const selectRow   = document.getElementById('select-row');
    const roundingSel = document.getElementById('rounding');
    const resultBox   = document.getElementById('result');
    const progress    = document.getElementById('progress');
    const selects = [];

    function buildSelects(){
      selectRow.innerHTML = '';
      for(let i=0;i<5;i++){
        const id = `sel-${i}`;
        const wrap = document.createElement('div');
        const lab  = document.createElement('label'); lab.setAttribute('for', id); lab.textContent = `${i+1}人目`;
        const sel  = document.createElement('select');
        sel.id = id; sel.dataset.index = i;

        const optNone = document.createElement('option');
        optNone.value = ''; optNone.textContent = '未選択'; optNone.style.color = 'var(--text)';
        sel.appendChild(optNone);

        RANK_LABELS.forEach((label, idx) => {
          const opt = document.createElement('option');
          opt.value = String(idx + 1);
          opt.textContent = label;
          const tier = (label === 'Radiant') ? 'Radiant' : label.split(' ')[0];
          opt.style.color = COLOR[tier] || 'var(--text)';
          sel.appendChild(opt);
        });

        sel.addEventListener('change', onChangeAny);
        wrap.appendChild(lab); wrap.appendChild(sel); selectRow.appendChild(wrap);
        selects.push(sel);

        applySelectedColor(sel);
      }
    }

    function applySelectedColor(sel){
      const val = sel.value ? Number(sel.value) : null;
      if(!val){ sel.style.color = 'var(--text)'; return; }
      const tierIndex = val === 25 ? 8 : Math.floor((val-1)/3);
      const tierName = val === 25 ? 'Radiant' : TIERS[tierIndex];
      sel.style.color = COLOR[tierName] || 'var(--text)';
    }

    function onChangeAny(e){
      applySelectedColor(e.target);
      updateProgress(); computeIfReady();
    }

    function updateProgress(){
      const missing = selects.filter(s=>!s.value).length;
      progress.innerHTML = `<small class="helper">未選択 : ${missing} / 5</small>`;
    }

    function computeIfReady(){
      const ords = selects.map(s => s.value ? Number(s.value) : null);
      if(ords.some(v => v === null)){
        resultBox.textContent = '平均ランク : —（5人すべて選択してください）';
        resultBox.style.borderColor = '#2b3246';
        return;
      }
      const { avgLabel } = getAvgFromOrdinals(ords, roundingSel.value);
      const tierName = (avgLabel === 'Radiant') ? 'Radiant' : avgLabel.split(' ')[0];
      const color = COLOR[tierName] || 'var(--text)';
      resultBox.innerHTML = `平均ランク : <strong style="color:${color}">${avgLabel}</strong><br/><small class="helper">選択 : ${ords.map(o=>RANK_LABELS[o-1]).join(' / ')}</small>`;
      resultBox.style.borderColor = color;
    }

    document.getElementById('clear-all').addEventListener('click', ()=>{
      selects.forEach(s=> { s.value=''; applySelectedColor(s); });
      updateProgress(); computeIfReady();
    });
    roundingSel.addEventListener('change', computeIfReady);

    buildSelects(); updateProgress();

    const LS_KEY = 'valorant_avgrank_teams_v1';
    function readTeams(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)) ?? {}; }catch{ return {}; } }
    function writeTeams(obj){ localStorage.setItem(LS_KEY, JSON.stringify(obj)); }
    function refreshTeamList(){
      const list = document.getElementById('team-list');
      const all = readTeams(); const names = Object.keys(all).sort((a,b)=> a.localeCompare(b,'ja'));
      list.innerHTML = '';
      if(names.length===0){ list.innerHTML = `<li class="meta">（保存はまだありません）</li>`; return; }
      for(const name of names){
        const li = document.createElement('li'); li.className='team';
        const left = document.createElement('div'); left.innerHTML = `<strong>${name}</strong><div class="meta">${all[name].labels.join(' / ')}</div>`;
        const right = document.createElement('div'); right.className='controls';
        const loadBtn = document.createElement('button'); loadBtn.className='secondary'; loadBtn.textContent='読み込み';
        loadBtn.addEventListener('click', ()=>{
          const ords = all[name].ordinals;
          for(let i=0;i<5;i++){ selects[i].value = ords[i] ? String(ords[i]) : ''; applySelectedColor(selects[i]); }
          updateProgress(); computeIfReady(); document.getElementById('team-name').value = name;
        });
        const delBtn = document.createElement('button'); delBtn.className='danger'; delBtn.textContent='削除';
        delBtn.addEventListener('click', ()=>{
          if(confirm(`「${name}」を削除しますか？`)){
            const obj = readTeams(); delete obj[name]; writeTeams(obj); refreshTeamList();
          }
        });
        right.appendChild(loadBtn); right.appendChild(delBtn); li.appendChild(left); li.appendChild(right); list.appendChild(li);
      }
    }
    refreshTeamList();

    document.getElementById('save-team').addEventListener('click', ()=>{
      const name = document.getElementById('team-name').value.trim();
      if(!name){ alert('チーム名を入力してください'); return; }
      const ords = selects.map(s=> s.value ? Number(s.value) : null);
      if(ords.some(v=>v===null)){ alert('5人すべて選択してください'); return; }
      const obj = readTeams(); const exists = !!obj[name];
      if(exists && !confirm(`「${name}」は既に存在します。上書きしますか？`)) return;
      obj[name] = { ordinals: ords, labels: ords.map(o=>RANK_LABELS[o-1]), savedAt: Date.now() };
      writeTeams(obj); refreshTeamList(); alert(exists ? '上書き保存しました' : '保存しました');
    });
    document.getElementById('delete-all').addEventListener('click', ()=>{
      if(confirm('保存済みチームをすべて削除しますか？')){ localStorage.removeItem(LS_KEY); refreshTeamList(); }
    });
  </script>
</body>
</html>


